import Mathlib.CategoryTheory.Bicategory.Basic
import Mathlib.CategoryTheory.EqToHom
import HeytingLean.LoF.Combinators.Category.Completion2Path

/-!
# Completion2PathBicategory ‚Äî a non-thin bicategory from completion generators

`Completion2Path` provides non-thin 2-cells between parallel labeled paths as paths in a
completion-rule generator quiver.

As raw generator paths, these 2-cells do not satisfy the bicategory exchange law strictly.
This file constructs a bicategory by quotienting the 2-cells by the exchange relation and
closing under vertical composition and whiskering.
-/

namespace HeytingLean
namespace LoF
namespace Combinators
namespace Category

open CategoryTheory

open HeytingLean.LoF
open HeytingLean.LoF.Comb

/-! ## The exchange congruence on `Completion2Path` -/

/-- A relation on `Completion2Path` generated by the bicategory exchange law and closed under
vertical composition and whiskering. -/
inductive Completion2PathRel :
    ‚àÄ {a b : MWObj} {p q : a ‚ü∂ b}, Completion2Path p q ‚Üí Completion2Path p q ‚Üí Prop
  | vcomp_left {a b : MWObj} {p q r : a ‚ü∂ b}
      (Œ∑‚ÇÅ Œ∑‚ÇÇ : Completion2Path p q) (Œ∏ : Completion2Path q r) :
      Completion2PathRel Œ∑‚ÇÅ Œ∑‚ÇÇ ‚Üí
        Completion2PathRel (Completion2Path.vcomp Œ∑‚ÇÅ Œ∏) (Completion2Path.vcomp Œ∑‚ÇÇ Œ∏)
  | vcomp_right {a b : MWObj} {p q r : a ‚ü∂ b}
      (Œ∑ : Completion2Path p q) (Œ∏‚ÇÅ Œ∏‚ÇÇ : Completion2Path q r) :
      Completion2PathRel Œ∏‚ÇÅ Œ∏‚ÇÇ ‚Üí
        Completion2PathRel (Completion2Path.vcomp Œ∑ Œ∏‚ÇÅ) (Completion2Path.vcomp Œ∑ Œ∏‚ÇÇ)
  | whisker_left {a b c : MWObj} (f : a ‚ü∂ b) {g h : b ‚ü∂ c}
      (Œ∑ Œ∑' : Completion2Path g h) :
      Completion2PathRel Œ∑ Œ∑' ‚Üí
        Completion2PathRel (Completion2Path.whiskerLeft f Œ∑) (Completion2Path.whiskerLeft f Œ∑')
  | whisker_right {a b c : MWObj} {f g : a ‚ü∂ b}
      (Œ∑ Œ∑' : Completion2Path f g) (h : b ‚ü∂ c) :
      Completion2PathRel Œ∑ Œ∑' ‚Üí
        Completion2PathRel (Completion2Path.whiskerRight Œ∑ h) (Completion2Path.whiskerRight Œ∑' h)
  | whisker_left_id {a b c : MWObj} (f : a ‚ü∂ b) (g : b ‚ü∂ c) :
      Completion2PathRel
        (Completion2Path.whiskerLeft f (Completion2Path.id g))
        (Completion2Path.id (f ‚â´ g))
  | whisker_left_comp {a b c : MWObj} (f : a ‚ü∂ b) {g h i : b ‚ü∂ c}
      (Œ∑ : Completion2Path g h) (Œ∏ : Completion2Path h i) :
      Completion2PathRel
        (Completion2Path.whiskerLeft f (Completion2Path.vcomp Œ∑ Œ∏))
        (Completion2Path.vcomp (Completion2Path.whiskerLeft f Œ∑) (Completion2Path.whiskerLeft f Œ∏))
  | id_whisker_left {a b : MWObj} {f g : a ‚ü∂ b} (Œ∑ : Completion2Path f g) :
      Completion2PathRel
        (Completion2Path.whiskerLeft (ùüô a) Œ∑)
        (Completion2Path.vcomp (Completion2Path.id f) (Completion2Path.vcomp Œ∑ (Completion2Path.id g)))
  | comp_whisker_left {a b c d : MWObj} (f : a ‚ü∂ b) (g : b ‚ü∂ c) {h h' : c ‚ü∂ d}
      (Œ∑ : Completion2Path h h') :
      Completion2PathRel
        (Completion2Path.whiskerLeft (f ‚â´ g) Œ∑)
        (Completion2Path.vcomp (Completion2Path.eqToHom (LSteps.comp_assoc f g h))
          (Completion2Path.vcomp (Completion2Path.whiskerLeft f (Completion2Path.whiskerLeft g Œ∑))
            (Completion2Path.eqToHom (LSteps.comp_assoc f g h').symm)))
  | id_whisker_right {a b c : MWObj} (f : a ‚ü∂ b) (g : b ‚ü∂ c) :
      Completion2PathRel
        (Completion2Path.whiskerRight (Completion2Path.id f) g)
        (Completion2Path.id (f ‚â´ g))
  | comp_whisker_right {a b c : MWObj} {f g h : a ‚ü∂ b} (Œ∑ : Completion2Path f g)
      (Œ∏ : Completion2Path g h) (i : b ‚ü∂ c) :
      Completion2PathRel
        (Completion2Path.whiskerRight (Completion2Path.vcomp Œ∑ Œ∏) i)
        (Completion2Path.vcomp (Completion2Path.whiskerRight Œ∑ i) (Completion2Path.whiskerRight Œ∏ i))
  | whisker_right_id {a b : MWObj} {f g : a ‚ü∂ b} (Œ∑ : Completion2Path f g) :
      Completion2PathRel
        (Completion2Path.whiskerRight Œ∑ (ùüô b))
        (Completion2Path.vcomp (Completion2Path.eqToHom (LSteps.comp_refl_right f))
          (Completion2Path.vcomp Œ∑ (Completion2Path.eqToHom (LSteps.comp_refl_right g).symm)))
  | whisker_right_comp {a b c d : MWObj} {f f' : a ‚ü∂ b} (Œ∑ : Completion2Path f f')
      (g : b ‚ü∂ c) (h : c ‚ü∂ d) :
      Completion2PathRel
        (Completion2Path.whiskerRight Œ∑ (g ‚â´ h))
        (Completion2Path.vcomp (Completion2Path.eqToHom (LSteps.comp_assoc f g h).symm)
          (Completion2Path.vcomp (Completion2Path.whiskerRight (Completion2Path.whiskerRight Œ∑ g) h)
            (Completion2Path.eqToHom (LSteps.comp_assoc f' g h))))
  | whisker_assoc {a b c d : MWObj} (f : a ‚ü∂ b) {g g' : b ‚ü∂ c} (Œ∑ : Completion2Path g g')
      (h : c ‚ü∂ d) :
      Completion2PathRel
        (Completion2Path.whiskerRight (Completion2Path.whiskerLeft f Œ∑) h)
        (Completion2Path.vcomp (Completion2Path.eqToHom (LSteps.comp_assoc f g h))
          (Completion2Path.vcomp (Completion2Path.whiskerLeft f (Completion2Path.whiskerRight Œ∑ h))
            (Completion2Path.eqToHom (LSteps.comp_assoc f g' h).symm)))
  | whisker_exchange {a b c : MWObj}
      {f g : a ‚ü∂ b} {h i : b ‚ü∂ c}
      (Œ∑ : Completion2Path f g) (Œ∏ : Completion2Path h i) :
      Completion2PathRel
        (Completion2Path.vcomp (Completion2Path.whiskerLeft f Œ∏) (Completion2Path.whiskerRight Œ∑ i))
        (Completion2Path.vcomp (Completion2Path.whiskerRight Œ∑ h) (Completion2Path.whiskerLeft g Œ∏))
  | pentagon {a b c d e : MWObj} (f : a ‚ü∂ b) (g : b ‚ü∂ c) (h : c ‚ü∂ d) (i : d ‚ü∂ e) :
      Completion2PathRel
        (Completion2Path.vcomp
          (Completion2Path.whiskerRight (Completion2Path.eqToHom (LSteps.comp_assoc f g h)) i)
          (Completion2Path.vcomp (Completion2Path.eqToHom (LSteps.comp_assoc f (g ‚â´ h) i))
            (Completion2Path.whiskerLeft f (Completion2Path.eqToHom (LSteps.comp_assoc g h i)))))
        (Completion2Path.vcomp (Completion2Path.eqToHom (LSteps.comp_assoc (f ‚â´ g) h i))
          (Completion2Path.eqToHom (LSteps.comp_assoc f g (h ‚â´ i))))
  | triangle {a b c : MWObj} (f : a ‚ü∂ b) (g : b ‚ü∂ c) :
      Completion2PathRel
        (Completion2Path.vcomp (Completion2Path.eqToHom (LSteps.comp_assoc f (ùüô b) g))
          (Completion2Path.whiskerLeft f (Completion2Path.id g)))
        (Completion2Path.whiskerRight (Completion2Path.eqToHom (LSteps.comp_refl_right f)) g)

/-! ## The quotient hom-category -/

/-- 2-cells in the quotient hom-category. -/
abbrev Completion2PathQuot {a b : MWObj} (p q : a ‚ü∂ b) : Type :=
  Quot (Completion2PathRel (a := a) (b := b) (p := p) (q := q))

namespace Completion2PathQuot

/-- Category structure on each hom-type `a ‚ü∂ b`, with morphisms the quotient 2-cells. -/
def homCategory (a b : MWObj) : Category (a ‚ü∂ b) where
  Hom p q := Completion2PathQuot p q
  id p := Quot.mk _ (Completion2Path.id (a := a) (b := b) p)
  comp Œ∑ Œ∏ :=
    Quot.map‚ÇÇ (fun x y => Completion2Path.vcomp x y)
      (fun Œ∑ Œ∏‚ÇÅ Œ∏‚ÇÇ hRel => Completion2PathRel.vcomp_right (a := a) (b := b) Œ∑ Œ∏‚ÇÅ Œ∏‚ÇÇ hRel)
      (fun Œ∑‚ÇÅ Œ∑‚ÇÇ Œ∏ hRel => Completion2PathRel.vcomp_left (a := a) (b := b) Œ∑‚ÇÅ Œ∑‚ÇÇ Œ∏ hRel)
      Œ∑ Œ∏
  id_comp := by
    intro X Y f
    refine Quot.inductionOn f ?_
    intro Œ∑
    simp [Completion2Path.id, Completion2Path.vcomp]
  comp_id := by
    intro X Y f
    refine Quot.inductionOn f ?_
    intro Œ∑
    simp [Completion2Path.id, Completion2Path.vcomp]
  assoc := by
    intro W X Y Z f g h
    refine Quot.inductionOn f ?_
    intro Œ∑
    refine Quot.inductionOn g ?_
    intro Œ∏
    refine Quot.inductionOn h ?_
    intro Œπ
    simp [Completion2Path.vcomp]

end Completion2PathQuot

/-! ## A bridge from `eqToIso` to the quotient constructors -/

/-- In the quotient hom-category, `eqToHom` is represented by the empty generator path. -/
theorem eqToHom_eq_mk {a b : MWObj} {p q : a ‚ü∂ b} (h : p = q) :
    (by
        letI : Category (a ‚ü∂ b) := Completion2PathQuot.homCategory a b
        exact (CategoryTheory.eqToHom h : p ‚ü∂ q)) =
      Quot.mk _ (Completion2Path.eqToHom (a := a) (b := b) h) := by
  letI : Category (a ‚ü∂ b) := Completion2PathQuot.homCategory a b
  cases h
  rfl

/-! ## The bicategory on `MWObj` -/

/-- A non-thin bicategory on `MWObj` obtained by quotienting `Completion2Path` by the exchange law. -/
def skyCompletion2PathQuotBicategory : Bicategory MWObj where
  toCategoryStruct := (inferInstance : CategoryStruct MWObj)
  homCategory a b := Completion2PathQuot.homCategory a b
  whiskerLeft {a b c} f {g h} Œ∑ :=
    Quot.map (Completion2Path.whiskerLeft (a := a) (b := b) (c := c) f)
      (fun x y hRel => Completion2PathRel.whisker_left (f := f) x y hRel)
      Œ∑
  whiskerRight {a b c} {f g} Œ∑ h :=
    Quot.map (fun x => Completion2Path.whiskerRight (a := a) (b := b) (c := c) x h)
      (fun x y hRel => Completion2PathRel.whisker_right (h := h) x y hRel)
      Œ∑
  associator {a b c d} f g h := by
    letI : Category (a ‚ü∂ d) := Completion2PathQuot.homCategory a d
    exact eqToIso (LSteps.comp_assoc f g h)
  leftUnitor {a b} f := by
    letI : Category (a ‚ü∂ b) := Completion2PathQuot.homCategory a b
    exact eqToIso (by rfl)
  rightUnitor {a b} f := by
    letI : Category (a ‚ü∂ b) := Completion2PathQuot.homCategory a b
    exact eqToIso (LSteps.comp_refl_right f)
  whiskerLeft_id := by
    intro a b c f g
    exact Quot.sound (Completion2PathRel.whisker_left_id (f := f) (g := g))
  whiskerLeft_comp := by
    intro a b c f g h i Œ∑ Œ∏
    refine Quot.inductionOn Œ∑ ?_
    intro Œ∑'
    refine Quot.inductionOn Œ∏ ?_
    intro Œ∏'
    exact Quot.sound (Completion2PathRel.whisker_left_comp (f := f) (Œ∑ := Œ∑') (Œ∏ := Œ∏'))
  id_whiskerLeft := by
    intro a b f g Œ∑
    refine Quot.inductionOn Œ∑ ?_
    intro Œ∑'
    exact Quot.sound (Completion2PathRel.id_whisker_left (Œ∑ := Œ∑'))
  comp_whiskerLeft := by
    intro a b c d f g h h' Œ∑
    refine Quot.inductionOn Œ∑ ?_
    intro Œ∑'
    simpa [eqToHom_eq_mk] using
      (Quot.sound (Completion2PathRel.comp_whisker_left (f := f) (g := g) (Œ∑ := Œ∑')))
  id_whiskerRight := by
    intro a b c f g
    exact Quot.sound (Completion2PathRel.id_whisker_right (f := f) (g := g))
  comp_whiskerRight := by
    intro a b c f g h Œ∑ Œ∏ i
    refine Quot.inductionOn Œ∑ ?_
    intro Œ∑'
    refine Quot.inductionOn Œ∏ ?_
    intro Œ∏'
    exact Quot.sound (Completion2PathRel.comp_whisker_right (Œ∑ := Œ∑') (Œ∏ := Œ∏') (i := i))
  whiskerRight_id := by
    intro a b f g Œ∑
    refine Quot.inductionOn Œ∑ ?_
    intro Œ∑'
    simpa [eqToHom_eq_mk] using
      (Quot.sound (Completion2PathRel.whisker_right_id (Œ∑ := Œ∑')))
  whiskerRight_comp := by
    intro a b c d f f' Œ∑ g h
    refine Quot.inductionOn Œ∑ ?_
    intro Œ∑'
    simpa [eqToHom_eq_mk] using
      (Quot.sound (Completion2PathRel.whisker_right_comp (Œ∑ := Œ∑') (g := g) (h := h)))
  whisker_assoc := by
    intro a b c d f g g' Œ∑ h
    refine Quot.inductionOn Œ∑ ?_
    intro Œ∑'
    simpa [eqToHom_eq_mk] using
      (Quot.sound (Completion2PathRel.whisker_assoc (f := f) (Œ∑ := Œ∑') (h := h)))
  whisker_exchange := by
    intro a b c f g h i Œ∑ Œ∏
    refine Quot.inductionOn Œ∑ ?_
    intro Œ∑'
    refine Quot.inductionOn Œ∏ ?_
    intro Œ∏'
    exact Quot.sound (Completion2PathRel.whisker_exchange (Œ∑ := Œ∑') (Œ∏ := Œ∏'))
  pentagon := by
    intro a b c d e f g h i
    simpa [eqToHom_eq_mk] using
      (Quot.sound (Completion2PathRel.pentagon (f := f) (g := g) (h := h) (i := i)))
  triangle := by
    intro a b c f g
    simpa [eqToHom_eq_mk] using
      (Quot.sound (Completion2PathRel.triangle (f := f) (g := g)))

end Category
end Combinators
end LoF
end HeytingLean
